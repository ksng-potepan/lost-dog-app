<% @sighting.each do |sighting|%>
  <div id="easyModal<%= sighting.id %>" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>目撃情報の詳細</h2>
        <span class="modalClose">×</span>
      </div>
      <div class="modal-body">
        <div class="modal-image">
          <% if @user.image.attached? %>
            <%= image_tag @user.image, :size => '200x200' %>
          <% else %>
            <%= image_tag("default_user.png", :size => "200x200") %>
          <% end %>
        </div>
        <h3>日時：</h3>
        <p><%= l sighting.date %></p>
        <p><%= sighting.time %></p>
        <h3>場所：</h3>
        <p><%= sighting.area %></p>
        <h3>状況：</h3>
        <p><%= sighting.situation %></p>
        <p>
          <% if sighting.user_id == current_user.id %>
            <%= button_to sighting_path(sighting), method: :delete, data: { turbo: false } do %>
              <i class="fa-solid fa-trash">投稿を削除</i>
            <% end %>
          <% else %>
            <%= sighting.user.username %>様
            <%= link_to user_path(sighting.user_id) do %>
              <i class="fa-solid fa-envelope"></i>連絡をする
            <% end %>
          <% end %>
        </p>
      </div>
    </div>
  </div>
<% end %>

<div class="sighting-map-index">
  <h2>ー 目撃情報マップ ー</h2>
  <div id='map'></div>
</div>

<!-- js部分 -->
<script>
  function modalOpenById(id) {
    const modal = document.getElementById(`easyModal${id}`);
    modal.style.display = 'block';
  }

  function modalClose(modal) {
    modal.style.display = 'none';
  }

  function outsideClose(modal, e) {
    if (e.target == modal) {
      modal.style.display = 'none';
    }
  }

  function initMap() {
    //初期表示位置
    let latlng = new google.maps.LatLng(38.60, 139.5);
    //デザイン
    let styles = [
      {
        stylers: [
          { "saturation": 0 },
          { "lightness": 0 }
        ]
      }
    ];

    let map = new google.maps.Map(document.getElementById('map'), {
        zoom: 5.5,
        styles: styles,
        center: latlng
    });
    let transitLayer = new google.maps.TransitLayer();
    transitLayer.setMap(map);

    //複数マーカー ここから
    <% @sighting.each do |sighting|%>
      ( function() {
        let markerLatLng = { lat: <%= sighting.lat %>, lng: <%= sighting.lng %> }; // 緯度経度のデータ作成
        let marker = new google.maps.Marker({
          position: markerLatLng,
          map: map
        });
        // マーカーをクリックしたとき、詳細情報を表示
        let infowindow = new google.maps.InfoWindow({
          position: markerLatLng,
          content: `<button id="modalOpen<%= sighting.id %>" class="button" onclick="modalOpenById(<%= sighting.id %>)">詳細を見る</button>`
        }); //ここで詳細ページへのリンクを表示させる
        marker.addListener('click', function() {
          infowindow.open(map, marker);
        });
      })();
    <% end %>

    const modals = document.getElementsByClassName('modal');
    [...modals].forEach((modal) => {
      modal.addEventListener('click', (e) => {
        outsideClose(modal, e);
      })
      const closeBtn = modal.firstElementChild.firstElementChild.lastElementChild;
      closeBtn.addEventListener('click', () => {
        modalClose(modal);
      });
    });
    //複数マーカー ここまで
  }


</script>
<script src="https://maps.googleapis.com/maps/api/js?key=<%=ENV['MAP_API']%>&callback=initMap" async defer></script>
